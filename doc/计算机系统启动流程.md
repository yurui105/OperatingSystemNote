# 计算机系统启动
## **目录**
1. 计算机体系结构概述
2. 计算机内存和硬盘布局
3. 系统启动流程

## ==1、计算机体系结构概述==
在了解计算机体系之后，我们知道计算机由CPU、IO设备以及存储器构成，而这些构成元素之间我们用总线进行通讯。具体可表示为下图：
<p align="center">
  <img src="https://raw.githubusercontent.com/yurui105/image/master/image/2019/03/27/%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB-1553651789848.png" width="192">
</p>
在上图中，CPU具有计算能力，它可以执行指令；I/O设备可以连接一些外围设备来进行输入输出；内存具有存储能力，存储程序运行的一些数据。

在这个我们着重讨论CPU在计算机加电后怎么样执行第一条程序？第一条只能在哪？

## ==2、计算机内存和硬盘布局==
在计算机加电后，由于系统处于16位实模式且只有20位的地址空间可用，所以最多只能访问内存的1MB处。

在加电后，首先会经过BIOS加电自检，在内存1MB下面有一段自检程序，在BIOS自检完成后，会初始化CPU的CS（代码段寄存器）和IP（指令指针寄存器），把CS初始化为0xf000，把IP初始化为fff0。

然后通过把CS地址左移四位再加上IP得到真实的物理地址，也就是此时的跳转访问地址。既	    ```PC=16*CS+IP```

为了能顺利的读到数据，BIOS还需提供一些基本的功能：
- 基本的输入输出程序
- 系统设置信息
- 开机后自检程序
- 系统自启动程序等

上诉的内存可从下图得到直观的展现
<p align="center">
  <img src="https://raw.githubusercontent.com/yurui105/image/master/image/2019/03/26/%E5%86%85%E5%AD%98-1553609248372.png" width="150">
</p>


在BIOS完成初始化后，将加载程序从磁盘的引导扇区（512字节）读到内存的0x7c00处，然后跳转到PC（0x7c00）处。此时加载程序将操作系统代码以及数据加载到内存中，进而将控制权交由操作系统。此时内存布局如下图所示
<p align="center">
  <img src="https://raw.githubusercontent.com/yurui105/image/master/image/2019/03/26/%E5%9B%BE%E7%89%871-1553611533462.png" width="450">
</p>


由此就完成了操作系统内核的加载以及启动。

## ==3、系统启动流程==
在上面我们说了系统的启动流程是加电后BIOS自检，自检完成后读加载程序，然后加载程序去读内核映像。但这个流程我们还可以细化下去，前面说了在BIOS执行完后直接读加载程序，但其实这个过程是不能直接进行的。

对于以前的计算机，我们都只有一个分区，所以BIOS直接跳转到分区中找文件系统。但是对于现在的计算机来说，我们往往都不仅只有一个分区，我们通常有多个分区，而每个分区都可能有不同的文件系统，因此我们需要在读加载程序之前先读主引导记录，主引导记录会记录从哪个文件系统中去读取加载程序。

有了主引导分区后我们就可以进去活动分区，在活动分区中又有一个引导记录，而这个引导记录就将告诉BIOS去哪个分区中读取加载程序。整个过程如下图所示
<p align="center">
  <img src="https://raw.githubusercontent.com/yurui105/image/master/image/2019/03/27/%E5%9B%BE%E7%89%872-1553616213116.png" width="400">
</p>

接下来将对整个启动过程做一个总结

### <1>CPU初始化
- **CPU加电稳定后从0xFFFF0读取粗体第一条指令**
	- CS:IP=0xf000：fff0
	- 第一条指令为跳转指令
- **CPU初始状态为16位实模式**
	- CS:IP是16位寄存器
	- 指令指针PC=16*CS+IP
	- 最大寻址空间为1MB

### <2>BIOS初始化

- **硬件自检（检测关键部位）**
- **查找并执行显卡等接口卡BIOS，初始化硬件**
- **执行系统BIOS，进行系统检测**
- **更新CMOS中扩展系统配置数据ESCD**
- **按指定启动数据从软盘/硬盘/光驱启动**

### <3>主引导记录（512字节）MBR格式

- **启动代码（446字节）**
	- 检查分区表正确性
	- 加载并跳转到磁盘上的引导程序
- **硬盘分区表（64字节）**
	- 描述分区状态和位置
	- 每个分区描述信息占据16字节
- **结束标志（2字节，0x55及0xaa）**
	- 主引导记录有效标志

### <4>分区引导扇区格式
- **JMP(跳转指令)**
	- 与平台相关的代码
- **文件
