# 中断、异常和系统调用
## 目录
1. 背景
2. 中断
3. 异常
4. 系统调用
5. 中断、异常和系统调用比较

## 1、背景
- **为什么需要中断、异常和系统调用机制**
1. 在[1、计算机系统启动流程](https://github.com/yurui105/OperatingSystemNote/blob/master/doc/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.md)中我们已经知道，在计算机系统启动后，会加载操作系内核到内存中，进而将控制权交由操作系统。在这一过程中，是可以被信任的。但是在实际的应用中，操作系统之上还有许多应用程序，而对于这些应用程序，操作系统是没法做到完全信任的，而应用程序又要使用到操作系统提供的内核服务。这时我们就要解决操作系统内核和外界打交道的问题，通常操作系统内核会提供一个接口（interface）供上层应用程序使用。而上层应用在使用这些接口的时候，可能会产生非法指令，那这时操作系统就需要异常机制来处理应用程序来产生的非法指令。
2. 由于计算机还有很多外围设备，当这些外围设备使用时操作系统如何来处理。比如当用户键盘输入时，由于用户的输入时间以及内容是不确定的，用户在输入时操作系统可能在处理其他的问题，那这时操作系统该如何来处理用户输入的信息。这时，我们就需要操作系统提供中断的机制来处理用户键盘产生的输入。
3. 除了上述的两种情况，操作系统还需要解决的一个问题是如何为上层应用提供系统调用服务，操作系统既要为上层的应用服务提供一个访问的接口，同时这个接口又不能对操作系统产生威胁。*就比如银行和客户，银行既要为客户提供服务，但是它还得有一些机制，防止用户威胁到银行的安全。*这样的问题同样存在于操作系统与应用程序之间，而这也就是系统调用所要解决的内容。


## 2、中断
在前面我们说过操作系统内核要处理来自外围设备的处理请求，如下图所示
<p align="center">
  <img src="https://raw.githubusercontent.com/yurui105/image/master/image/2019/03/27/%E5%9B%BE%E7%89%871-1553677802491.png" width="300">
</p>
操作系统内核提供了一些内核服务，这些内核服务会和外围设备打交道。比如说用户产生硬盘输入，输入内容进入缓冲区，而缓冲区是有大小限制的，可能用户在产生下一个输入时，前面的内容还没被读走，这是新的输入内容进入缓冲区，就会产生缓冲区溢出。对于这种情况，在键盘产生数据输入的时候，就要通知内核产生中断，然后由内核通知设备驱动，设备驱动来和外围设备产生数据交互。

### 中断
-	来自硬件设备的处理请求


## 3、异常
在应用程序执行的过程中，正常执行的程序跟应用程序没关系，但当程序执行出现异常时，就需要内核来处理程序执行所产生的异常。比如做除法运算的程序，在执行过程中发现除数为零，或者程序在执行过程中访问了某些不能访问的存储单元。此时代码执行出错，就需要用到操作系统提供的异常机制来处理。如下图所示
<p align="center">
  <img src="https://raw.githubusercontent.com/yurui105/image/master/image/2019/03/27/%E5%9B%BE%E7%89%874-1553693370383.png" width="350">
</p>

对于异常来说，一部分是事先能预测到的，比如程序所访问的内存单元原来不存在，这是操作系统可以把存储单元的内容放到内存里，这对于虚拟内存来说是可以实现的。另一种情况，如做了除零运算，这是程序无法运行下去，就会把应用程序所占用的系统资源统统还给操作系统。
### 异常
- 非法指令或其它原因导致的当前指令执行失败

## 4、系统调用
程序在正常的执行过程中，会使用到函数库，而函数库可以通过系统调用间接地使用到操作系统内核。如下图所示
<p align="center">
  <img src="https://raw.githubusercontent.com/yurui105/image/master/image/2019/03/27/%E5%9B%BE%E7%89%873-1553693863990.png" width="330">
</p>

比如应用程序要对硬盘进行读写操作，而程序不能直接对硬盘进行读写操作，此时应用程序只能使用操作系统提供的硬盘读写系统调用接口间接地进行文件读写。
### 系统调用
- 应用程序主动向操作系统发出的服务请求

## 5、中断、异常和系统调用比较
上面所说的中断、异常和系统调用可由下图完整表示
<p align="center">
  <img src="https://raw.githubusercontent.com/yurui105/image/master/image/2019/03/27/%E5%9B%BE%E7%89%875-1553694876641.png" width="350">
</p>
接下来就来对中断、异常和系统调用进行比较

### 源头
- 中断：外设
- 异常：应用程序意想不到的行为
- 系统调用：应用程序请求操作系统提供服务

### 响应方式
- 中断：异步
- 异常：同步
- 系统调用：异步或同步

### 处理机制
- 中断：持续的，对用户程序是透明的
- 异常：杀死或者重新执行应用程序指令
- 系统调用：等待和持续

### 中断处理机制
- 1、硬件处理
	- 在CPU初始化时设置中断使能标志
		- 依据内部或外部事件设置中断标志
		- 依据中断向量调用相应中断服务例程
- 2、软件处理
- 
